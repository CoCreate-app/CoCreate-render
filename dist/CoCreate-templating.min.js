/* CoCreateJS */
var eOBJs=[],engineWrapperClass="template-wrapper";function initSocketsForEngine(){CoCreateSocket.listen("readDocumentList",function(e){e.created_ids?fetchedDocumentForEngine(e):fetchedEngine(e)}),CoCreateSocket.listen("createDocument",function(e){createdDocumentForEngine(e)}),CoCreateSocket.listen("deleteDocument",function(e){deletedDocumentForEngine(e)})}function initEngines(e){let t=e||document;if(!t.querySelectorAll)return;let a=t.querySelectorAll("."+engineWrapperClass);0==a.length&&t!=document&&t.hasAttribute(engineWrapperClass)&&(a=[t]);for(let e=0;e<a.length;e++){let t=a[e],n=g_cocreateFilter.setFilter(t,"data-template_id","template");if(!n)continue;if(CoCreateUtils.getInitialized(t))continue;CoCreateUtils.setInitialized(t);let l={el:t,filter:n,templateId:t.getAttribute("data-template_id"),availableMore:!0};eOBJs.push(l),t.addEventListener("changeFilterInput",function(e){removeOldData(l.el),l.filter.startIndex=0,g_cocreateFilter.fetchData(l.filter)}),g_cocreateFilter.fetchData(n)}}function initTemplateByElement(e,t){let a=e.getAttribute("data-template_id");if(!a)return;let n=g_cocreateFilter.getObjectByFilterId(eOBJs,a),l=null;if(n)l=n.filter,g_cocreateFilter.changeCollection(l),t&&(removeOldData(e),l.startIndex=0);else{if(!(l=g_cocreateFilter.setFilter(e,"data-template_id","template")))return;n={el:e,filter:l,templateId:a,availableMore:!0},eOBJs.push(n),e.addEventListener("changeFilterInput",function(e){removeOldData(n.el),n.filter.startIndex=0,g_cocreateFilter.fetchData(n.filter)})}g_cocreateFilter.fetchData(l)}function fetchedEngine(e){let t=e.element,a=g_cocreateFilter.getObjectByFilterId(eOBJs,t);if(a){const t=e.data;a.filter.startIndex+=t.length;let n=a.el;a.filter.is_collection?showCollectionListEngine(n,t):showFetchedEngine(n,e.collection,t)}}function showCollectionListEngine(e,t){let a=e.querySelector(".template");if(!a)return;let n=e.getAttribute("data-template_id"),l=e.getAttribute("data-pass_to"),i=document.createElement("div"),r=e.querySelector(".template");r.getAttribute("data-template_id")!=n&&(r=e.querySelector("template-wrapper >.template"));for(let e=0;e<t.length;e++){let a=t[e],o=document.createElement("div"),c=r.cloneNode(!0);c.removeAttribute("id"),c.classList.remove("template"),c.setAttribute("templateId",n),o.appendChild(c.cloneNode(!0));let d=o.querySelectorAll("h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code, img"),s=o.getElementsByTagName("a");for(let e=0;e<d.length;e++){let t=d[e],n=t.getAttribute("data-pass_id");l&&l==n&&(t.hasAttribute("data-value")&&t.setAttribute("data-value",a.name),("name"==t.getAttribute("name")||t.classList.contains("collection-name"))&&(t.textContent=a.name),"id"==t.getAttribute("name")&&(t.textContent=a._id))}for(let e=0;e<s.length;e++){let t=s[e];t.getAttribute("data-pass_to")&&(t.classList.add("newLink"),t.setAttribute("data-pass_collection",a.name))}i.insertAdjacentHTML("beforeend",o.innerHTML)}a.insertAdjacentHTML("beforebegin",i.innerHTML)}function showFetchedEngine(e,t,a,n){let l=e.querySelector(".template");if(!l)return;let i=[];a.forEach(function(e){i.push(e._id)});let r=getEngineResltTemplate(e,t,i),o=e.getAttribute("data-template_id");var c=null;n&&(c=e.querySelector("[templateId="+o+"]:nth-child("+(n+1)+")")),c?c.insertAdjacentHTML("beforebegin",r.innerHTML):l.insertAdjacentHTML("beforebegin",r.innerHTML);var d=new CustomEvent("fetchedTemplate",{bubbles:!0});e.dispatchEvent(d),initNewAtags(e.parentNode);let s=e.parentNode.getElementsByTagName("form");for(let e=0;e<s.length;e++){let t=s[e],a=t.querySelector(".passValueBtn");a&&CoCreateLogic.__registerValuePassBtnEvent(t,a)}CoCreate.fetchModules(e.parentNode),initEngines(e),CoCreate.initModules(e.parentNode)}function createdDocumentForEngine(e){let t=e.collection;for(let a=0;a<eOBJs.length;a++){let n=eOBJs[a];n.fetch_ids=[];let l=[];if(n.filter.collection==t&&n.filter.fetch.value&&n.filter.fetch.value===e.data[n.filter.fetch.name]&&l.push(e.document_id),l.length>0){let e=g_cocreateFilter.makeFetchOptions(n.item);e.created_ids=l,CoCreate.readDocumentList(e)}}}function fetchedDocumentForEngine(e){console.log(e);let t=e.element,a=g_cocreateFilter.getObjectByFilterId(eOBJs,t);if(a){a.filter.startIndex+=e.data.length;let t=a.el,n=e.collection;e.data.forEach((e,a)=>{showFetchedEngine(t,n,[e.item],e.position)})}}function deletedDocumentForEngine(e){let t=e.collection,a=e.document_id;for(let e=0;e<eOBJs.length;e++){let i=eOBJs[e];if(i.filter.collection==t){var n=i.el.getAttribute("data-template_id"),l=i.el.querySelectorAll("[templateId='"+n+"'][data-document_id='"+a+"'");for(let e=0;e<l.length;e++)l[e].remove(),i.startIndex--}}}function getEngineResltTemplate(e,t,a){let n=e.getAttribute("data-template_id"),l=e.getAttribute("data-pass_to"),i=document.createElement("div"),r=e.querySelector(".template"),o=r.getAttribute("data-template_id");o&&o!=n&&(r=e.querySelector("template-wrapper >.template"));for(let e=0;e<a.length;e++){let o=a[e],c=document.createElement("div"),d=r.cloneNode(!0);d.setAttribute("templateId",n),d.removeAttribute("id"),d.classList.remove("template"),d.setAttribute("data-document_id",o),c.appendChild(d.cloneNode(!0));let s=c.querySelectorAll("div, h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code, img, tr, td"),u=c.getElementsByTagName("input"),g=(c.getElementsByTagName("textarea"),c.getElementsByTagName("a"));for(let e=0;e<s.length;e++){let a=s[e],n=a.getAttribute("data-pass_id");l&&l==n&&(a.classList.contains("template-wrapper")?(a.setAttribute("data-template_id",o),a.setAttribute("data-fetch_value",o)):a.classList.contains("template")?a.setAttribute("data-template_id",o):(a.setAttribute("data-collection",t),a.setAttribute("data-document_id",o)))}for(let e=0;e<g.length;e++){let t=g[e];t.getAttribute("data-pass_to")&&(t.classList.add("newLink"),t.setAttribute("data-pass_document_id",o))}u=c.querySelectorAll("input, textarea");for(let e=0;e<u.length;e++){let t=u[e],a=t.getAttribute("data-pass_id");l&&l==a&&t.setAttribute("data-document_id",o)}i.appendChild(c.firstChild)}return i}function removeOldData(e){let t=e.getAttribute("data-template_id"),a=e.querySelectorAll("[templateId='"+t+"']");for(let e=0;e<a.length;e++)a[e].remove()}function initNewAtags(e){let t=e.querySelectorAll("a");for(let e=0;e<t.length;e++)t[e].classList.contains("newLink")&&initNewATag(t[e])}function initNewATag(e){let t=e.getAttribute("href");CoCreateLogic.checkOpenCocreateModal(e)?e.addEventListener("click",function(t){t.preventDefault(),CoCreateLogic.storePassData(e),g_cocreateWindow.openWindow(e)}):t&&e.addEventListener("click",function(t){t.preventDefault(),CoCreateLogic.storePassData(e),CoCreateLogic.openAnother(e)})}function initLoadMoreButtons(){let e=document.querySelectorAll(".loadMore");for(let t=0;t<e.length;t++){e[t].addEventListener("click",function(e){e.preventDefault();let t=this.getAttribute("data-template_id");if(!t)return;let a=g_cocreateFilter.getObjectByFilterId(eOBJs,t);console.log(a,t),a&&a.filter.count>0&&g_cocreateFilter.fetchData(a.filter)})}}function findTemplateElByChild(e){return CoCreateUtils.getParentFromElement(e,engineWrapperClass)}function updateParentTemplateOfChild(e,t){var a=e.getAttribute("data-fetch_name"),n=e.getAttribute("data-fetch_value"),l=e.getAttribute("data-fetch_collection"),i=t.getAttribute("data-document_id");a&&CoCreate.replaceDataCrdt({collection:l,document_id:i,name:a,value:n,update_crud:!0})}function reorderChildrenOfTemplate(e){const t=e.getAttribute("data-order_by"),a=e.getAttribute("data-order_type")||"asc",n=e.getAttribute("data-fetch_collection"),l=e.getAttribute("data-template_id");if(!t||!l)return;var i=e.querySelectorAll(`[data-template_id="${l}"][data-document_id]`);const r="asc"==a?1:-1;i.forEach((e,a)=>{const l=e.getAttribute("data-document_id");CoCreate.replaceDataCrdt({collection:n,document_id:l,name:t,value:a*r,update_crud:!0})})}initEngines(),initSocketsForEngine(),initLoadMoreButtons(),CoCreateInit.register("CoCreateTemplate",window,initEngines);